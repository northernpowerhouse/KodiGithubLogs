name: Build Kodi Addon

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
      - '[0-9]+.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from addon.xml
        id: get_version
        run: |
          VERSION=$(grep '<addon' addon.xml | grep -oP 'version="\K[^"]+')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Addon version: $VERSION"
      
      - name: Create addon zip
        run: |
          mkdir -p build/script.kodigithublogs
          # Copy addon files (exclude repo, .github, build)
          rsync -av --exclude='.git' --exclude='.github' --exclude='repo' --exclude='build' --exclude='repository.kodigithublogs' --exclude='*.pyc' --exclude='__pycache__' . build/script.kodigithublogs/
          cd build
          zip -r script.kodigithublogs-${{ steps.get_version.outputs.version }}.zip script.kodigithublogs
          cd ..
      
      - name: Create repository zip
        run: |
          # Create zip from parent directory to include the folder structure
          zip -r build/repository.kodigithublogs.zip repository.kodigithublogs
      
      - name: Update repo structure
        run: |
          mkdir -p repo/script.kodigithublogs
          cp build/script.kodigithublogs-${{ steps.get_version.outputs.version }}.zip repo/script.kodigithublogs/
          
          # Update addons.xml with current addon.xml content
          cat > repo/addons.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <addons>
          EOF
          
          # Extract addon element from addon.xml (remove XML declaration)
          sed '1d' addon.xml >> repo/addons.xml
          
          cat >> repo/addons.xml << 'EOF'
          </addons>
          EOF
          
          # Generate MD5
          md5sum repo/addons.xml | awk '{print $1}' > repo/addons.xml.md5
      
      - name: Commit repo updates
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add repo/
          git diff --staged --quiet || git commit -m "Update repo for version ${{ steps.get_version.outputs.version }}"
          git push
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## KodiGithubLogs v${{ steps.get_version.outputs.version }}
            
            ### Installation Options
            
            **Option 1: Install via Repository (Recommended)**
            1. Download `repository.kodigithublogs.zip`
            2. In Kodi: Add-ons → Install from zip file → Select the repository zip
            3. Install from repository → KodiGithubLogs Repository → Program add-ons → KodiGithubLogs
            
            **Option 2: Direct Installation**
            1. Download `script.kodigithublogs-${{ steps.get_version.outputs.version }}.zip`
            2. In Kodi: Add-ons → Install from zip file → Select the addon zip
            
            ### Features
            - GitHub Device Flow authentication
            - Upload logs to GitHub repositories
            - Support for regular/debug/trace log levels
            - Folder navigation and creation
            - Filter startup logs
            
            ### Ready to Use
            No OAuth App setup required - just install and authorize!
            
            Advanced users can optionally create their own OAuth App at:
            https://github.com/settings/developers
          files: |
            build/script.kodigithublogs-${{ steps.get_version.outputs.version }}.zip
            build/repository.kodigithublogs.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kodi-addon-packages
          path: |
            build/script.kodigithublogs-*.zip
            build/repository.kodigithublogs.zip

